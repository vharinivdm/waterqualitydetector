{% extends "base.html" %}

{% block title %}History - AquaGuard AI{% endblock %}
{% block page_title %}Reading History{% endblock %}

{% block content %}

<!-- Filter Section -->
<div class="glass-card mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Filter Type</label>
            <select class="form-select" id="filterType">
                <option value="all">All Readings</option>
                <option value="quality">Water Quality Only</option>
                <option value="meter">Meter Readings Only</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Date From</label>
            <input type="date" class="form-control" id="dateFrom">
        </div>
        <div class="col-md-3">
            <label class="form-label">Date To</label>
            <input type="date" class="form-control" id="dateTo">
        </div>
        <div class="col-md-2">
            <button class="btn btn-gradient w-100" onclick="applyFilters()">
                <i class="bi bi-funnel"></i> Filter
            </button>
        </div>
    </div>
</div>

<!-- Export Button -->
<div class="text-end mb-3">
    <a href="/api/export_report?type=csv" class="btn btn-outline-light">
        <i class="bi bi-download"></i> Export Report
    </a>
</div>

<!-- Water Quality History -->
<div class="glass-card mb-4" id="qualityHistorySection">
    <div class="card-header-custom">
        <h3><i class="bi bi-droplet-fill"></i> Water Quality History</h3>
        <span class="badge bg-info">{{ quality_history|length }} Records</span>
    </div>
    
    <div class="table-responsive">
        <table class="table table-dark">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Date & Time</th>
                    <th>Status</th>
                    <th>Safety Score</th>
                    <th>Alert Level</th>
                    <th>Location</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if quality_history %}
                    {% for reading in quality_history %}
                    <tr>
                        <td>{{ reading.id }}</td>
                        <td>{{ reading.timestamp }}</td>
                        <td>
                            {% if reading.safety_status == 'SAFE' %}
                            <span class="badge badge-success">{{ reading.safety_status }}</span>
                            {% else %}
                            <span class="badge badge-danger">{{ reading.safety_status }}</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ reading.safety_score }}/100</strong></td>
                        <td>
                            {% if reading.alert_level == 'HIGH' %}
                            <span class="badge badge-danger">HIGH</span>
                            {% elif reading.alert_level == 'MEDIUM' %}
                            <span class="badge badge-warning">MEDIUM</span>
                            {% else %}
                            <span class="badge badge-success">NONE</span>
                            {% endif %}
                        </td>
                        <td>{{ reading.location or 'N/A' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-light" onclick="viewDetails('quality', {{ reading.id }})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center" style="color: rgba(255,255,255,0.5);">
                            No water quality readings yet
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Meter Reading History -->
<div class="glass-card" id="meterHistorySection">
    <div class="card-header-custom">
        <h3><i class="bi bi-speedometer"></i> Meter Reading History</h3>
        <span class="badge bg-info">{{ meter_history|length }} Records</span>
    </div>
    
    <div class="table-responsive">
        <table class="table table-dark">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Date & Time</th>
                    <th>Reading</th>
                    <th>Usage Status</th>
                    <th>Meter ID</th>
                    <th>Location</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if meter_history %}
                    {% for reading in meter_history %}
                    <tr>
                        <td>{{ reading.id }}</td>
                        <td>{{ reading.timestamp }}</td>
                        <td><strong>{{ reading.reading_value }} L</strong></td>
                        <td>
                            {% if reading.is_high_usage %}
                            <span class="badge badge-warning">High Usage</span>
                            {% else %}
                            <span class="badge badge-success">Normal</span>
                            {% endif %}
                        </td>
                        <td>{{ reading.meter_id or 'N/A' }}</td>
                        <td>{{ reading.location or 'N/A' }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-light" onclick="viewDetails('meter', {{ reading.id }})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center" style="color: rgba(255,255,255,0.5);">
                            No meter readings yet
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row g-4 mt-2">
    <div class="col-md-4">
        <div class="glass-card text-center">
            <h5>Total Quality Tests</h5>
            <div style="font-size: 2.5rem; font-weight: 700; color: #00a8e8;">{{ quality_history|length }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="glass-card text-center">
            <h5>Total Meter Scans</h5>
            <div style="font-size: 2.5rem; font-weight: 700; color: #00a8e8;">{{ meter_history|length }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="glass-card text-center">
            <h5>Combined Records</h5>
            <div style="font-size: 2.5rem; font-weight: 700; color: #00a8e8;">{{ quality_history|length + meter_history|length }}</div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: rgba(20, 20, 40, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h5 class="modal-title" id="detailsModalLabel">Reading Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically loaded -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <button type="button" class="btn btn-outline-light" onclick="deleteReading()">
                    <i class="bi bi-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentReadingType = null;
    let currentReadingId = null;

    function applyFilters() {
        const filterType = document.getElementById('filterType').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        // Show/hide sections based on filter
        const qualitySection = document.getElementById('qualityHistorySection');
        const meterSection = document.getElementById('meterHistorySection');
        
        if (filterType === 'all') {
            qualitySection.style.display = 'block';
            meterSection.style.display = 'block';
        } else if (filterType === 'quality') {
            qualitySection.style.display = 'block';
            meterSection.style.display = 'none';
        } else if (filterType === 'meter') {
            qualitySection.style.display = 'none';
            meterSection.style.display = 'block';
        }
        
        // In a real implementation, you would filter by date range as well
        if (dateFrom || dateTo) {
            console.log('Date filtering:', dateFrom, 'to', dateTo);
            // Implement date filtering logic here
        }
    }
    
    async function viewDetails(type, id) {
        currentReadingType = type;
        currentReadingId = id;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modal.show();
        
        // Load details
        try {
            const response = await fetch(`/api/reading_details?type=${type}&id=${id}`);
            const data = await response.json();
            
            if (data.error) {
                document.getElementById('modalBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error}
                    </div>
                `;
                return;
            }
            
            // Display details based on type
            if (type === 'quality') {
                displayQualityDetails(data);
            } else {
                displayMeterDetails(data);
            }
        } catch (error) {
            document.getElementById('modalBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error loading details: ${error.message}
                </div>
            `;
        }
    }
    
    function displayQualityDetails(data) {
        const statusBadge = data.safety_status === 'SAFE' 
            ? '<span class="badge badge-success">SAFE ‚úÖ</span>'
            : '<span class="badge badge-danger">UNSAFE ‚ùå</span>';
            
        const alertBadge = data.alert_level === 'HIGH'
            ? '<span class="badge badge-danger">HIGH</span>'
            : data.alert_level === 'MEDIUM'
            ? '<span class="badge badge-warning">MEDIUM</span>'
            : '<span class="badge badge-success">NONE</span>';
        
        const imageHtml = data.image_path 
            ? `<div class="text-center mb-3">
                <img src="/${data.image_path}" alt="Water Sample" 
                     style="max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2);">
               </div>`
            : '';
        
        document.getElementById('modalBody').innerHTML = `
            <div class="row g-3">
                <div class="col-12">
                    <h5 style="color: #00a8e8;"><i class="bi bi-droplet-fill"></i> Water Quality Reading #${data.id}</h5>
                </div>
                
                ${imageHtml}
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Status</small>
                        <div class="mt-1">${statusBadge}</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Safety Score</small>
                        <div class="mt-1"><strong style="font-size: 1.5rem; color: ${data.safety_score > 70 ? '#00b894' : '#d63031'};">${data.safety_score}/100</strong></div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Alert Level</small>
                        <div class="mt-1">${alertBadge}</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Timestamp</small>
                        <div class="mt-1"><i class="bi bi-calendar"></i> ${data.timestamp}</div>
                    </div>
                </div>
                
                <div class="col-12">
                    <h6 style="color: #667eea; margin-top: 1rem;">üìä AI Analysis Details</h6>
                </div>
                
                <div class="col-md-3">
                    <div class="p-3 text-center" style="background: rgba(255,100,100,0.1); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Hue</small>
                        <div class="mt-1"><strong>${data.mean_hue ? data.mean_hue.toFixed(2) : 'N/A'}</strong></div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="p-3 text-center" style="background: rgba(100,255,100,0.1); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Saturation</small>
                        <div class="mt-1"><strong>${data.mean_saturation ? data.mean_saturation.toFixed(2) : 'N/A'}</strong></div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="p-3 text-center" style="background: rgba(100,100,255,0.1); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Value</small>
                        <div class="mt-1"><strong>${data.mean_value ? data.mean_value.toFixed(2) : 'N/A'}</strong></div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="p-3 text-center" style="background: rgba(255,200,100,0.1); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Texture</small>
                        <div class="mt-1"><strong>${data.texture_score ? data.texture_score.toFixed(2) : 'N/A'}</strong></div>
                    </div>
                </div>
                
                ${data.location ? `
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);"><i class="bi bi-geo-alt"></i> Location</small>
                        <div class="mt-1">${data.location}</div>
                    </div>
                </div>
                ` : ''}
                
                ${data.notes ? `
                <div class="col-12">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);"><i class="bi bi-sticky"></i> Notes</small>
                        <div class="mt-1">${data.notes}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function displayMeterDetails(data) {
        const usageBadge = data.is_high_usage
            ? '<span class="badge badge-warning">High Usage ‚ö†Ô∏è</span>'
            : '<span class="badge badge-success">Normal Usage ‚úÖ</span>';
        
        const imageHtml = data.image_path 
            ? `<div class="text-center mb-3">
                <img src="/${data.image_path}" alt="Meter Reading" 
                     style="max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2);">
               </div>`
            : '';
        
        document.getElementById('modalBody').innerHTML = `
            <div class="row g-3">
                <div class="col-12">
                    <h5 style="color: #00a8e8;"><i class="bi bi-speedometer"></i> Meter Reading #${data.id}</h5>
                </div>
                
                ${imageHtml}
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Reading Value</small>
                        <div class="mt-1"><strong style="font-size: 1.8rem; color: #00a8e8;">${data.reading_value} L</strong></div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Usage Status</small>
                        <div class="mt-1">${usageBadge}</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Timestamp</small>
                        <div class="mt-1"><i class="bi bi-calendar"></i> ${data.timestamp}</div>
                    </div>
                </div>
                
                ${data.meter_id ? `
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);">Meter ID</small>
                        <div class="mt-1"><i class="bi bi-hash"></i> ${data.meter_id}</div>
                    </div>
                </div>
                ` : ''}
                
                ${data.location ? `
                <div class="col-md-6">
                    <div class="p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);"><i class="bi bi-geo-alt"></i> Location</small>
                        <div class="mt-1">${data.location}</div>
                    </div>
                </div>
                ` : ''}
                
                ${data.conservation_tip ? `
                <div class="col-12">
                    <div class="p-3" style="background: rgba(0,184,148,0.1); border-left: 4px solid #00b894; border-radius: 10px;">
                        <small style="color: rgba(255,255,255,0.6);"><i class="bi bi-lightbulb"></i> Conservation Tip</small>
                        <div class="mt-1">${data.conservation_tip}</div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    async function deleteReading() {
        if (!currentReadingType || !currentReadingId) return;
        
        if (!confirm(`Are you sure you want to delete this ${currentReadingType} reading? This action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/delete_reading?type=${currentReadingType}&id=${currentReadingId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
                
                // Show success message and reload page
                alert('Reading deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error deleting reading: ' + error.message);
        }
    }
</script>
{% endblock %}
